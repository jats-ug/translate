# patsolve

(元記事は http://www.illtyped.com/projects/patsolve/ です)

patsolve 制約ソルバは、推論器にレバレッジをかけるために、ATS コンパイラの外で制約解決を行なおうとした努力の成果です。
これによって、制約解決がより信頼でき、より生産的になることを期待できます。
SMT ソルバのようなさかんに開発されているツールを使うことで、制約ソルバの答をより信頼することができます。
さらにそれらの広範囲にわたる判定力は、ATS プログラムにおけるより多くの特性の検証の自動化を可能にします。
現在の実装では patsolve は、ATS プログラムから生成された制約の正当性を検査するために、Z3 SMT ソルバを使っています。

patsolve の詳細の使い方については、次のインストール手順とケーススタディでの例を参照してください。

## 利点

もし SMT ソルバの使用経験がないとしても、ビルトインの制約ソルバを置き換えとして patsolve を効果的に使えます。
この置き換えを行なう理由は以下のようなものです:

### 安定性

ATS2 内部の制約ソルバは、Fourier-Motzkin 消去法を制約解決に使います。
これは上手く動作しますが、そのコードは特別製で修正することが困難でした。
対照的に、SMT ソルバはさかんに開発されているツールで、実装の正しさを綿密にテストされています。
SMT ソルバへの信頼は、その実装や、もっと重要なことには判定手順をデバッグすることを心配する必要がありません。

### 判定力

静的なビットベクトルや配列のようなより進んだ領域での使用でない場合でさえ、SMT ソルバは時に不変条件の検査のためにしなければならない作業を軽減してくれます。
これは事例にもとづいた主張です。
にもかかわらず、SMT ソルバの絶え間ない改良は ATS の静的な部分に力を与えるでしょう。

## インストール手順

このソルバを手元で動作させるには、最新の ATS と関連した contrib パッケージをインストールしてください。
次の依存したプログラムをインストールする必要があります:

* [Z3](http://z3.codeplex.com/) (4.3.2)
* python 2.7.x (申し分けないのですが, python 3 は Z3py をサポートしていません)

次に、contrib パッケージの次のフォルダに移動します。

```
projects/MEDIUM/ATS-extsolve
```

そしてビルドします。

```
make
```

PATSHOME 環境変数を設定しているのであれば、patsolve バイナリがパスに配置されるでしょう。
もし設定していない場合、patsolve を (ATS がインストールされたルートディレクトリに) インストールするために次のコマンドを実行する必要があります。

```
cp patsolve $PATSHOME/bin/
```

これで、例を型検査するセットアップは終わりです。
Z3 に直接さわるために、私達は python スクリプトインターフェイスを用意しています。
これによって関数を解釈し、python を使って SMT マクロを定義できます。
このツールを使うことで、コマンドライン引数に python スクリプトを渡すことができます。

次のコマンドは、ケーススタディで紹介するクイックソートの例を示しています。

```
cd $PATSHOME/contrib/libats-/wdblair/prelude/
patsopt --constraint-export -tc -d TEST/quicksort.dats | patsolve -s SMT/stampseq.py
```

うまく行けば、ファイルが型検査されたことを示すメッセージが見えるでしょう。
制約解決の SMT-LIB 2 トレースが見たい場合、`-v` スイッチを patsolve に追加します。
制約ソルバと Z3 の間における SMT-LIB 2 似た全ての記録が見れるはずです。

## 使い方

ビルトインの制約ソルバの置き換えとして patsolve を使うためには、次のようにプログラムを型検査します。

```
patsopt --constraint-export -tc -d foo.dats | patsolve
```

未解決の制約がなくなったら、patsopt を再度呼び出すことで、制約解決をスキップして C コードを生成できます。

```
patsopt --constraint-ignore -d foo.dats
```

## ケーススタディとチュートリアル

### [Scripting patsolve](http://www.illtyped.com/projects/patsolve/scripting.html)

Z3Py ライブラリを使った patsolve の機能の拡張方法を紹介した短かいチュートリアルです。

### [Verified Efficient Programs in ATS: qsort](http://www.illtyped.com/projects/patsolve/qsort.html)

ポインタ演算を使った標準 C ライブラリ上の qsort 関数の実装方法です。
この実装はメモリの安全性と関数の正確さをも検査しています。

## 今後

Z3 が patsolve の基盤となる SMT ソルバでなければならない特別な理由はありません。
本質的に自動的な定理証明としてソルバを使うのであれば、Coq や Isabelle のような対話的な定理証明器を使って制約解決をしたくなります。
私達は、帰納的なデータ構造の性質の証明のように、SMT ソルバが相応わしくない複雑な領域において、これらの証明器は有用であると想像しています。
様々な困難さの制約を扱う、複数のレイヤから成る制約ソルバを想像できるかもしれません。
最上位のレイヤでは、今日の ATS プログラムに見られる制約を証明できるような Z3 を持っています。
その次のレイヤでは、Coq のようなシステムが、リストや木のようなデータ型のような帰納法を必要とする制約を証明するために使われるかもしれません。

その一方で、CVC4 の使用をサポートし、python インターフェイイスを一般的なファイルベースのインターフェイスに置き換えたいと考えています。
